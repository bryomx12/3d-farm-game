<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rustic Harvest 3D</title>
    <script src="https://unpkg.com/three@0.150.0/build/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #051408; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; pointer-events: none; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .overlay { position: absolute; inset: 0; background: rgba(0,20,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; color: gold; z-index: 100; text-align: center; }
        .btn { padding: 15px 40px; font-size: 22px; background: #ffd700; border: none; cursor: pointer; font-weight: bold; border-radius: 50px; margin: 10px; transition: 0.2s; }
        .btn:hover { transform: scale(1.1); background: white; }
        .btn:disabled { background: #555; cursor: not-allowed; }
        .label { position: absolute; background: rgba(0,0,0,0.6); color: white; padding: 2px 8px; border-radius: 5px; font-size: 12px; border: 1px solid gold; pointer-events: none; }
    </style>
</head>
<body>
    <div id="ui">
        <h1 id="money">ðŸ’° 100g</h1>
        <h3 id="day">Day 1</h3>
        <p id="inv">Inventory: Empty (0/3)</p>
    </div>

    <div id="start-overlay" class="overlay">
        <h1 style="font-size: 60px; margin: 0;">RUSTIC HARVEST</h1>
        <p style="color: white; font-size: 20px;">WASD to Move | Click Animals & Crops</p>
        <button class="btn" onclick="startGame()">BEGIN FARMING</button>
    </div>

    <div id="shop-overlay" class="overlay" style="display: none;">
        <h1>MARKET CLOSED</h1>
        <div id="shop-items"></div>
        <button class="btn" onclick="nextDay()" style="background: #fff;">SLEEP</button>
    </div>

    <script>
        // --- GAME STATE ---
        let scene, camera, renderer, player, clock;
        let money = 100, inventory = [], day = 1, served = 0;
        let keys = {}, unlocked = ['chicken', 'carrot'], crops = { carrot: 0, tomato: 0 };
        let isPlaying = false;

        // --- MODELS ---
        function createChibi(color) {
            const group = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.9, 0.5), new THREE.MeshStandardMaterial({color}));
            body.position.y = 0.75; body.castShadow = true;
            group.add(body);
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.35), new THREE.MeshStandardMaterial({color: 0xffdbac}));
            head.position.y = 1.35; head.castShadow = true;
            group.add(head);
            const lLeg = new THREE.Mesh(new THREE.CapsuleGeometry(0.1, 0.3), new THREE.MeshStandardMaterial({color: 0x111111}));
            lLeg.position.set(-0.2, 0.2, 0); group.add(lLeg);
            const rLeg = new THREE.Mesh(new THREE.CapsuleGeometry(0.1, 0.3), new THREE.MeshStandardMaterial({color: 0x111111}));
            rLeg.position.set(0.2, 0.2, 0); group.add(rLeg);
            group.userData = { lLeg, rLeg };
            return group;
        }

        function createPlant(type, growth) {
            const group = new THREE.Group();
            const size = growth / 100;
            const fruit = new THREE.Mesh(
                type === 'carrot' ? new THREE.ConeGeometry(0.15, 0.4) : new THREE.SphereGeometry(0.2),
                new THREE.MeshStandardMaterial({color: type === 'carrot' ? 0xffa500 : 0xff0000})
            );
            fruit.position.y = size * 0.2; group.add(fruit);
            const leaf = new THREE.Mesh(new THREE.BoxGeometry(0.05, 0.3, 0.1), new THREE.MeshStandardMaterial({color: 0x2e7d32}));
            leaf.position.y = size * 0.4; group.add(leaf);
            group.scale.set(size, size, size);
            return group;
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x051408);
            camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(15, 15, 15);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            clock = new THREE.Clock();

            // Lights
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(10, 20, 10); sun.castShadow = true;
            scene.add(sun);

            // Ground - Emerald Green
            const ground = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({color: 0x1b5e20}));
            ground.rotation.x = -Math.PI/2; ground.receiveShadow = true;
            scene.add(ground);

            // Player
            player = createChibi(0xffd700);
            scene.add(player);

            // Objects
            spawnWorld();

            window.addEventListener('keydown', e => keys[e.code] = true);
            window.addEventListener('keyup', e => keys[e.code] = false);
            window.addEventListener('mousedown', handleClick);
            animate();
        }

        function spawnWorld() {
            // Remove old
            scene.children.filter(c => c.userData.interact).forEach(c => scene.remove(c));

            // Chicken
            const coop = new THREE.Mesh(new THREE.BoxGeometry(2, 1.5, 2), new THREE.MeshStandardMaterial({color: 0x5d4037}));
            coop.position.set(-6, 0.75, 4); coop.userData = {interact: true, type: 'animal', item: 'egg'};
            scene.add(coop);

            // Patch
            const patch = new THREE.Mesh(new THREE.PlaneGeometry(2.5, 2.5), new THREE.MeshStandardMaterial({color: 0x3e2723}));
            patch.rotation.x = -Math.PI/2; patch.position.set(6, 0.01, -4);
            patch.userData = {interact: true, type: 'crop', item: 'carrot'};
            scene.add(patch);

            // Customer
            const cust = createChibi(0x3f51b5);
            cust.position.set(0, 0, -8); cust.userData = {interact: true, type: 'customer'};
            scene.add(cust);
        }

        function handleClick(e) {
            if (!isPlaying) return;
            const mouse = new THREE.Vector2((e.clientX/window.innerWidth)*2-1, -(e.clientY/window.innerHeight)*2+1);
            const ray = new THREE.Raycaster();
            ray.setFromCamera(mouse, camera);
            const hits = ray.intersectObjects(scene.children, true);
            
            if (hits.length > 0) {
                let obj = hits[0].object;
                while(obj.parent && !obj.userData.interact) obj = obj.parent;
                
                if (obj.userData.type === 'animal') {
                    if (inventory.length < 3) inventory.push(obj.userData.item);
                } else if (obj.userData.type === 'crop') {
                    if (crops.carrot >= 100) { inventory.push('carrot'); crops.carrot = 0; }
                    else crops.carrot = 1; // Start growing
                } else if (obj.userData.type === 'customer') {
                    if (inventory.includes('egg')) {
                        inventory.splice(inventory.indexOf('egg'), 1);
                        money += 30; served++;
                        if (served >= 5) endDay();
                    }
                }
                updateUI();
            }
        }

        function updateUI() {
            document.getElementById('money').innerText = `ðŸ’° ${money}g`;
            document.getElementById('inv').innerText = `Inventory: ${inventory.join(', ') || 'Empty'} (${inventory.length}/3)`;
        }

        function startGame() { 
            document.getElementById('start-overlay').style.display = 'none'; 
            isPlaying = true; 
        }

        function endDay() {
            isPlaying = false;
            document.getElementById('shop-overlay').style.display = 'flex';
        }

        function nextDay() {
            day++; served = 0;
            document.getElementById('day').innerText = `Day ${day}`;
            document.getElementById('shop-overlay').style.display = 'none';
            isPlaying = true;
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            const t = clock.getElapsedTime();

            if (isPlaying) {
                const move = new THREE.Vector3(0,0,0);
                if (keys.KeyW) move.z -= 1; if (keys.KeyS) move.z += 1;
                if (keys.KeyA) move.x -= 1; if (keys.KeyD) move.x += 1;
                
                if (move.length() > 0) {
                    move.normalize().multiplyScalar(8 * delta);
                    player.position.add(move);
                    player.rotation.y = Math.atan2(move.x, move.z);
                    // Walk animation
                    player.userData.lLeg.rotation.x = Math.sin(t * 12) * 0.5;
                    player.userData.rLeg.rotation.x = Math.cos(t * 12) * 0.5;
                }
                camera.position.lerp(new THREE.Vector3(player.position.x + 10, 10, player.position.z + 10), 0.1);
                camera.lookAt(player.position);

                if (crops.carrot > 0 && crops.carrot < 100) crops.carrot += delta * 20;
            }
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
